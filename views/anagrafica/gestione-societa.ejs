<!DOCTYPE html>
<html lang="it" data-theme="corporate">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Società</title>
    <!-- DaisyUI & Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        .actions-col {
            white-space: nowrap;
            width: 1%;
        }
    </style>
</head>
<body class="bg-base-200 min-h-screen">
    <div class="container mx-auto p-4">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div class="text-center md:text-left">
                <h1 class="text-2xl font-bold text-base-content">Gestione Società</h1>
                <div class="text-sm opacity-70">Elenco completo</div>
            </div>
            <div class="flex gap-2">
                <a href="/anagrafica/dettaglio-societa/nuova" target="_blank" class="btn btn-sm btn-success text-white">
                    <i class="bi bi-plus-lg"></i> Nuova Società
                </a>
                <button onclick="window.close()" class="btn btn-sm btn-neutral">Chiudi</button>
            </div>
        </div>

        <!-- Sezione Filtri -->
        <div class="card bg-base-100 shadow-xl mb-6">
            <div class="card-body p-6">
                <form id="filterForm" class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end" autocomplete="off">
                    <div class="md:col-span-3">
                        <label for="filter_ragione_sociale" class="label py-0 pb-1"><span class="label-text">Ragione Sociale</span></label>
                        <input type="text" class="input input-bordered input-sm w-full" id="filter_ragione_sociale" name="ragione_sociale">
                    </div>
                    <div class="md:col-span-3">
                        <label for="filter_partita_iva" class="label py-0 pb-1"><span class="label-text">Partita IVA</span></label>
                        <input type="text" class="input input-bordered input-sm w-full" id="filter_partita_iva" name="partita_iva">
                    </div>
                    <div class="md:col-span-3">
                        <label for="filter_codice_fiscale" class="label py-0 pb-1"><span class="label-text">Codice Fiscale</span></label>
                        <input type="text" class="input input-bordered input-sm w-full" id="filter_codice_fiscale" name="codice_fiscale">
                    </div>
                    <div class="md:col-span-3">
                        <label for="filter_codice_destinatario" class="label py-0 pb-1"><span class="label-text">Codice Destinatario</span></label>
                        <input type="text" class="input input-bordered input-sm w-full" id="filter_codice_destinatario" name="codice_destinatario">
                    </div>
                    <div class="md:col-span-12 flex justify-end gap-2 mt-2">
                        <button type="button" class="btn btn-sm btn-ghost" onclick="resetFilters()">Reset</button>
                        <button type="submit" class="btn btn-sm btn-primary"><i class="bi bi-search"></i> Cerca</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabella Risultati -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body p-0">
                <div class="overflow-x-auto rounded-box">
                    <table class="table table-zebra w-full">
                        <thead class="bg-base-200 text-base-content uppercase text-xs font-bold">
                            <tr>
                                <th>Ragione Sociale</th>
                                <th>Partita IVA</th>
                                <th>Codice Fiscale</th>
                                <th>Cod. Dest.</th>
                                <th>Settori</th>
                                <th class="actions-col text-right pr-4">Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="societaTableBody">
                            <!-- Contenuto caricato via AJAX -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    
    <script>
        // Funzione per gestire la conferma di eliminazione sicura
        function confirmDelete(formElement) {
            const input = prompt("ATTENZIONE: Questa operazione è irreversibile.\nPer confermare scrivi 'elimina':");
            if (input === 'elimina') {
                formElement.confirm_prompt.value = input;
                return true;
            }
            alert("Operazione annullata: codice di conferma errato.");
            return false;
        }

        // Funzione per caricare i dati via AJAX
        function loadSocieta() {
            const formData = new FormData(document.getElementById('filterForm'));
            const params = new URLSearchParams(formData).toString();
            
            fetch(`/api/anagrafica/societa?${params}`)
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('societaTableBody');
                    tbody.innerHTML = '';
                    
                    if (data.error) {
                        tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-error">Errore: ${data.error}</td></tr>`;
                        return;
                    }

                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 opacity-60">Nessuna società trovata con i filtri selezionati.</td></tr>';
                        return;
                    }

                    data.forEach(item => {
                        const row = `
                            <tr class="hover">
                                <td class="font-bold">${item.ragione_sociale}</td>
                                <td>${item.partita_iva || ''}</td>
                                <td>${item.codice_fiscale || ''}</td>
                                <td>${item.codice_destinatario || ''}</td>
                                <td>
                                    <div class="flex flex-wrap gap-1">
                                        ${item.settori ? item.settori.split(', ').map(tag => `<span class="badge badge-ghost bg-blue-50 text-blue-700 border-blue-200 h-auto py-1 px-2 rounded-lg text-xs">${tag}</span>`).join('') : ''}
                                    </div>
                                </td>
                                <td class="actions-col text-right">
                                    <div class="flex justify-end gap-1">
                                        <a href="/anagrafica/dettaglio-societa/${item.id}" target="_blank" class="btn btn-sm btn-square btn-primary" title="Dettaglio/Modifica">
                                            <i class="bi bi-pencil-square"></i>
                                        </a>
                                        <a href="/anagrafica/gestione-sedi?societa_id=${item.id}" target="_blank" class="btn btn-sm btn-square btn-info text-white" title="Gestione Sedi">
                                            <i class="bi bi-geo-alt"></i>
                                        </a>
                                        <a href="/anagrafica/gestione-uffici?societa_id=${item.id}" target="_blank" class="btn btn-sm btn-square btn-neutral" title="Gestione Uffici">
                                            <i class="bi bi-building"></i>
                                        </a>
                                        <a href="/anagrafica/gestione-referenti?societa_id=${item.id}" target="_blank" class="btn btn-sm btn-square btn-warning text-white" title="Gestione Referenti">
                                            <i class="bi bi-people"></i>
                                        </a>
                                        <form action="/anagrafica/gestione-societa/delete" method="POST" class="inline-block" onsubmit="return confirmDelete(this);">
                                            <input type="hidden" name="id" value="${item.id}">
                                            <input type="hidden" name="confirm_prompt">
                                            <button type="submit" class="btn btn-sm btn-square btn-error text-white" title="Elimina">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                })
                .catch(err => console.error('Errore caricamento dati:', err));
        }

        function resetFilters() {
            document.getElementById('filterForm').reset();
            loadSocieta();
        }

        // Carica i dati all'avvio e al submit del form
        document.addEventListener('DOMContentLoaded', () => { loadSocieta(); });
        document.getElementById('filterForm').addEventListener('submit', function(e) {
            e.preventDefault();
            loadSocieta();
        });
    </script>
</body>
</html>
