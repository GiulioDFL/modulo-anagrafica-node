<!DOCTYPE html>
<html lang="it" data-theme="corporate">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impostazioni - Chiave Valore</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body class="bg-base-200 min-h-screen">
    <div class="container mx-auto p-4">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-bold text-base-content">Impostazioni</h1>
                <div class="text-sm opacity-70">Gestione Chiave-Valore</div>
            </div>
            <button onclick="window.close()" class="btn btn-sm btn-neutral">Chiudi</button>
        </div>

        <!-- Form Inserimento Diretto -->
        <div class="card bg-base-100 shadow-xl mb-6">
            <div class="card-body p-6">
                <h2 class="card-title text-lg mb-4">Nuova Configurazione</h2>
                <form id="addForm" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                    <div class="form-control">
                        <label class="label py-0 pb-1"><span class="label-text">Gruppo *</span></label>
                        <input type="text" name="gruppo" class="input input-bordered input-sm w-full" required placeholder="Es. SETTORI">
                    </div>
                    <div class="form-control">
                        <label class="label py-0 pb-1"><span class="label-text">Chiave *</span></label>
                        <input type="text" name="chiave" class="input input-bordered input-sm w-full uppercase" required placeholder="Es. ABC" maxlength="3" minlength="3" pattern="[A-Z]{3}" title="3 lettere maiuscole" oninput="this.value = this.value.toUpperCase()">
                    </div>
                    <div class="form-control">
                        <label class="label py-0 pb-1"><span class="label-text">Valore *</span></label>
                        <input type="text" name="valore" class="input input-bordered input-sm w-full" required placeholder="Es. Information Technology">
                    </div>
                    <div class="form-control">
                        <label class="label py-0 pb-1"><span class="label-text">Attributo</span></label>
                        <input type="text" name="attributo" class="input input-bordered input-sm w-full" placeholder="Opzionale">
                    </div>
                    <div class="form-control">
                        <button type="submit" class="btn btn-sm btn-success text-white">
                            <i class="bi bi-plus-lg"></i> Aggiungi
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabella Dati -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body p-0">
                <div class="overflow-x-auto rounded-box">
                    <table class="table table-zebra w-full">
                        <thead class="bg-base-200 text-base-content uppercase text-xs font-bold">
                            <tr>
                                <th>Gruppo</th>
                                <th>Chiave</th>
                                <th>Valore</th>
                                <th>Attributo</th>
                                <th class="text-right pr-4">Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% items.forEach(item => { %>
                                <tr id="row-<%= item.id %>" class="hover">
                                    <!-- Visualizzazione -->
                                    <td class="view-mode font-bold"><%= item.gruppo %></td>
                                    <td class="view-mode"><%= item.chiave %></td>
                                    <td class="view-mode"><%= item.valore %></td>
                                    <td class="view-mode"><%= item.attributo || '-' %></td>
                                    
                                    <!-- Editing (Nascosto) -->
                                    <td class="edit-mode hidden p-1">
                                        <input type="text" class="input input-bordered input-xs w-full" id="edit-gruppo-<%= item.id %>" value="<%= item.gruppo %>">
                                    </td>
                                    <td class="edit-mode hidden p-1">
                                        <input type="text" class="input input-bordered input-xs w-full uppercase" id="edit-chiave-<%= item.id %>" value="<%= item.chiave %>" maxlength="3" minlength="3" pattern="[A-Z]{3}" oninput="this.value = this.value.toUpperCase()">
                                    </td>
                                    <td class="edit-mode hidden p-1">
                                        <input type="text" class="input input-bordered input-xs w-full" id="edit-valore-<%= item.id %>" value="<%= item.valore %>">
                                    </td>
                                    <td class="edit-mode hidden p-1">
                                        <input type="text" class="input input-bordered input-xs w-full" id="edit-attributo-<%= item.id %>" value="<%= item.attributo || '' %>">
                                    </td>

                                    <!-- Azioni -->
                                    <td class="text-right pr-4">
                                        <div class="view-mode inline-block">
                                            <button onclick="toggleEdit('<%= item.id %>')" class="btn btn-sm btn-square btn-ghost text-primary" title="Modifica">
                                                <i class="bi bi-pencil-square"></i>
                                            </button>
                                            <button onclick="deleteItem('<%= item.id %>')" class="btn btn-sm btn-square btn-ghost text-error" title="Elimina">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                        <div class="edit-mode hidden inline-block">
                                            <button onclick="saveItem('<%= item.id %>')" class="btn btn-sm btn-square btn-success text-white" title="Salva">
                                                <i class="bi bi-check-lg"></i>
                                            </button>
                                            <button onclick="toggleEdit('<%= item.id %>')" class="btn btn-sm btn-square btn-ghost" title="Annulla">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            <% }); %>
                            <% if (items.length === 0) { %>
                                <tr>
                                    <td colspan="5" class="text-center py-4 opacity-60">Nessuna configurazione trovata.</td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Gestione Inserimento
        document.getElementById('addForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            try {
                const res = await fetch('/settings/add', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if (res.ok) window.location.reload(); else alert('Errore durante l\'inserimento');
            } catch (err) { console.error(err); alert('Errore di comunicazione'); }
        });

        // Toggle ModalitÃ  Edit
        function toggleEdit(id) {
            const row = document.getElementById(`row-${id}`);
            row.querySelectorAll('.view-mode').forEach(el => el.classList.toggle('hidden'));
            row.querySelectorAll('.edit-mode').forEach(el => el.classList.toggle('hidden'));
        }

        // Salvataggio Modifica
        async function saveItem(id) {
            const data = { gruppo: document.getElementById(`edit-gruppo-${id}`).value, chiave: document.getElementById(`edit-chiave-${id}`).value, valore: document.getElementById(`edit-valore-${id}`).value, attributo: document.getElementById(`edit-attributo-${id}`).value };
            try { const res = await fetch(`/settings/update/${id}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); if (res.ok) window.location.reload(); else alert('Errore durante l\'aggiornamento'); } catch (err) { console.error(err); alert('Errore di comunicazione'); }
        }

        // Eliminazione
        async function deleteItem(id) { if (!confirm('Sei sicuro di voler eliminare questa riga?')) return; try { const res = await fetch(`/settings/delete/${id}`, { method: 'POST' }); if (res.ok) window.location.reload(); else alert('Errore durante l\'eliminazione'); } catch (err) { console.error(err); alert('Errore di comunicazione'); } }
    </script>
</body>
</html>