services:
  express-app:
    build: .
    container_name: modulo-anagrafica-container
    restart: always  # <--- QUESTA Ã¨ la riga magica per la VPS
    ports:
      - "127.0.0.1:3000:3000"
    environment:
      - PORT=${PORT}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - POCKET_BASE_URI=${POCKET_BASE_URI}
      - PB_ADMIN_EMAIL=${PB_ADMIN_EMAIL}
      - PB_ADMIN_PASSWORD=${PB_ADMIN_PASSWORD}
    volumes:
      - .:/app
      - /app/node_modules # Protegge i moduli installati nel container
  pocketbase:
    image: ghcr.io/muchobien/pocketbase:latest
    container_name: pocketbase-authenticator-container
    restart: unless-stopped
    environment:
      PB_HOST: ${PB_HOST}
      PB_PORT: ${PB_PORT}
      PB_ADMIN_EMAIL: ${PB_ADMIN_EMAIL}
      PB_ADMIN_PASSWORD: ${PB_ADMIN_PASSWORD}
      ENCRYPTION: ${PB_ENCRYPTION_KEY}
      TZ: ${PB_TZ}
    ports:
      # Limite interfaccia 127.0.0.1 per sicurezza (accessibile solo localmente/proxy)
      - "127.0.0.1:${PB_PORT}:${PB_PORT}"
    volumes:
      - ./pb_data:/pb_data
      - ./pb_public:/pb_public
      - ./pb_hooks:/pb_hooks
    # Applichiamo il flag per usare la chiave di criptazione definita in ENCRYPTION
    command: ["--encryptionEnv", "ENCRYPTION"]
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:${PB_PORT}/api/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
